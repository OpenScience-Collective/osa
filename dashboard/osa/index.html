<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Science Assistant - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            color: #374151;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        .header h1 { font-size: 2.2rem; margin-bottom: 0.5rem; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .header a { color: white; text-decoration: none; opacity: 0.8; }
        .header a:hover { opacity: 1; text-decoration: underline; }
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .card h2 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.4rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .metric {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            text-align: center;
        }
        .metric-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.25rem;
        }
        .metric-label {
            color: #6b7280;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Community cards on aggregate page */
        .community-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        .community-card {
            background: #f9fafb;
            border-radius: 10px;
            padding: 1.5rem;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            text-decoration: none;
            color: inherit;
            display: block;
        }
        .community-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .community-card h3 {
            color: #667eea;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        .community-card .stats {
            display: flex;
            gap: 1.5rem;
            color: #6b7280;
            font-size: 0.9rem;
        }
        .community-card .stats strong { color: #374151; }

        /* Tab bar */
        .tab-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .tab-link {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            border: 2px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.2s;
        }
        .tab-link:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }
        .tab-link.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        /* Period toggle */
        .period-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .period-btn {
            padding: 0.4rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .period-btn:hover { border-color: #667eea; }
        .period-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        .status-healthy { background: #d1fae5; color: #065f46; }
        .status-degraded { background: #fef3c7; color: #92400e; }
        .status-error { background: #fee2e2; color: #991b1b; }
        .status-unknown { background: #f3f4f6; color: #6b7280; }

        /* Charts */
        .chart-container { position: relative; height: 300px; margin: 1rem 0; }
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1rem 0;
        }
        @media (max-width: 768px) { .chart-row { grid-template-columns: 1fr; } }

        /* Admin section */
        .admin-section {
            display: none;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px dashed #e5e7eb;
        }
        .admin-section.visible { display: block; }
        .admin-section h3 { color: #667eea; margin-bottom: 1rem; font-size: 1.1rem; }
        .admin-input-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1rem;
        }
        .admin-input {
            padding: 0.6rem 1rem;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            flex: 1;
            max-width: 400px;
        }
        .admin-input:focus { outline: none; border-color: #667eea; }
        .admin-btn {
            padding: 0.6rem 1.2rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .admin-btn:hover { background: #5568d3; }
        .admin-status { font-size: 0.85rem; color: #6b7280; margin-left: 0.5rem; }
        .admin-status.success { color: #059669; }
        .admin-status.error { color: #dc2626; }

        /* Sync info */
        .sync-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .sync-item {
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        .sync-item-label { font-weight: 600; color: #374151; margin-bottom: 0.25rem; }
        .sync-item-value { color: #6b7280; font-size: 0.9rem; }

        /* Loading / error */
        .loading { text-align: center; color: #6b7280; padding: 2rem; }
        .loading::after {
            content: '';
            display: inline-block;
            width: 1.2rem; height: 1.2rem;
            border: 2px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg {
            color: #dc2626;
            background: #fee2e2;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .community-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .community-header h3 { font-size: 1.2rem; color: #374151; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" id="pageHeader">
            <h1>Open Science Assistant</h1>
            <p>Community Dashboard</p>
        </div>
        <div id="tabBar" class="tab-bar"></div>
        <div id="app" class="loading">Loading...</div>

        <!-- Admin Key Input (hidden until view loads successfully) -->
        <div class="card" id="adminCard" style="display:none;">
            <h2>Admin Access</h2>
            <p style="margin-bottom: 0.5rem; color: #6b7280;">
                Enter admin API key to view token usage, costs, and model details.
            </p>
            <div class="admin-input-row">
                <input type="password" id="adminKeyInput" class="admin-input"
                       placeholder="Admin API key..." autocomplete="off">
                <button class="admin-btn" onclick="unlockAdmin()">Unlock</button>
                <span id="adminStatus" class="admin-status"></span>
            </div>
        </div>
    </div>

    <script>
    // -----------------------------------------------------------------------
    // Configuration
    // -----------------------------------------------------------------------
    // API base URL. Priority: ?api= query param > window.OSA_API_BASE > auto-detect.
    // Auto-detection maps known dashboard hosts to their API backends.
    // Falls back to same-origin for local dev (uvicorn serves both).
    const API_BASE = (function() {
        const params = new URLSearchParams(window.location.search);
        if (params.get('api')) return params.get('api').replace(/\/+$/, '');
        if (window.OSA_API_BASE) return window.OSA_API_BASE.replace(/\/+$/, '');
        const host = window.location.hostname;
        if (host === 'osa-dash.pages.dev' || host === 'status.osc.earth')
            return 'https://api.osc.earth/osa';
        if (host.endsWith('.osa-dash.pages.dev') || host === 'develop-status.osc.earth')
            return 'https://api.osc.earth/osa-dev';
        return window.location.origin;
    })();

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function userFriendlyError(status, context) {
        if (!status) return `Unable to reach the API server. Check your connection or try again later.`;
        if (status === 429) return `Rate limit exceeded. Please wait a moment and try again.`;
        if (status === 404) return `${context || 'Resource'} not found. It may not exist or the URL may be incorrect.`;
        if (status === 401 || status === 403) return `Access denied. An API key may be required.`;
        if (status >= 500) return `The server encountered an error (${status}). Try again later.`;
        return `Unexpected error (HTTP ${status}). Try again later.`;
    }

    // -----------------------------------------------------------------------
    // State
    // -----------------------------------------------------------------------
    let adminKey = null;
    let activePeriod = 'daily';
    let overviewData = null;
    let usageChartInstance = null;
    let toolsChartInstance = null;
    let adminTokenChartInstance = null;
    let adminCostChartInstance = null;

    const COLORS = [
        '#667eea', '#764ba2', '#10b981', '#f59e0b', '#ef4444',
        '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16', '#f97316'
    ];

    // -----------------------------------------------------------------------
    // Router - read path to decide view
    // -----------------------------------------------------------------------
    const BASE_PATH = '/osa';

    function getRoute() {
        let path = window.location.pathname;
        if (path.startsWith(BASE_PATH)) path = path.slice(BASE_PATH.length);
        path = path.replace(/^\/+|\/+$/g, '');
        if (!path) return { view: 'aggregate', community: null };
        return { view: 'community', community: decodeURIComponent(path.split('/')[0]) };
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const app = document.getElementById('app');
        const route = getRoute();

        // Always fetch overview first to populate tabs
        let overviewStatus = null;
        try {
            const resp = await fetch(`${API_BASE}/metrics/public/overview`);
            overviewStatus = resp.status;
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            overviewData = await resp.json();
            renderTabs(overviewData.communities, route.community);
        } catch (err) {
            // If overview fetch fails, tabs won't render. Aggregate view will
            // show error; community views can still proceed.
            console.error('Failed to load overview for tab navigation:', err);
        }

        if (route.view === 'community') {
            loadCommunityView(route.community);
        } else {
            if (overviewData) {
                renderAggregateView(overviewData);
                document.getElementById('adminCard').style.display = '';
            } else {
                app.className = '';
                const msg = userFriendlyError(overviewStatus, 'Metrics overview');
                app.innerHTML = `<div class="error-msg">${escapeHtml(msg)}</div>`;
            }
        }
    });

    // -----------------------------------------------------------------------
    // Tabs
    // -----------------------------------------------------------------------
    function renderTabs(communities, activeCommunity) {
        const tabBar = document.getElementById('tabBar');
        if (!communities || communities.length === 0) return;

        let html = `<a href="${BASE_PATH}/" class="tab-link${activeCommunity === null ? ' active' : ''}">All</a>`;
        for (const c of communities) {
            const isActive = c.community_id === activeCommunity;
            const safe = escapeHtml(c.community_id);
            html += `<a href="${BASE_PATH}/${safe}" class="tab-link${isActive ? ' active' : ''}">${safe.toUpperCase()}</a>`;
        }
        tabBar.innerHTML = html;
    }

    // -----------------------------------------------------------------------
    // Aggregate View (root /)
    // -----------------------------------------------------------------------

    function renderAggregateView(data) {
        const app = document.getElementById('app');
        const successRate = data.total_requests > 0
            ? ((1 - data.error_rate) * 100).toFixed(1) : '0.0';

        let communityCards = '';
        if (data.communities && data.communities.length > 0) {
            communityCards = data.communities.map(c => {
                const cRate = c.requests > 0
                    ? ((1 - c.error_rate) * 100).toFixed(1) : '0.0';
                const safe = escapeHtml(c.community_id);
                return `
                    <a href="${BASE_PATH}/${safe}" class="community-card">
                        <h3>${safe.toUpperCase()}</h3>
                        <div class="stats">
                            <span><strong>${c.requests.toLocaleString()}</strong> requests</span>
                            <span><strong>${cRate}%</strong> success</span>
                        </div>
                    </a>`;
            }).join('');
        } else {
            communityCards = '<p style="color:#6b7280;">No community data yet. Select a community tab above.</p>';
        }

        app.className = '';
        app.innerHTML = `
            <div class="card">
                <h2>Overview</h2>
                <div class="overview-grid">
                    <div class="metric">
                        <div class="metric-value">${data.total_requests.toLocaleString()}</div>
                        <div class="metric-label">Questions Answered</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${data.communities_active}</div>
                        <div class="metric-label">Active Communities</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${successRate}%</div>
                        <div class="metric-label">Success Rate</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>Communities</h2>
                <div class="community-grid">${communityCards}</div>
            </div>
        `;
    }

    // -----------------------------------------------------------------------
    // Community View (/{community_id})
    // -----------------------------------------------------------------------
    async function loadCommunityView(communityId) {
        const app = document.getElementById('app');
        const safeName = escapeHtml(communityId);
        document.title = `${safeName.toUpperCase()} - OSA Dashboard`;

        try {
            const [summaryResp, usageResp, syncResp, healthResp] = await Promise.all([
                fetch(`${API_BASE}/${encodeURIComponent(communityId)}/metrics/public`),
                fetch(`${API_BASE}/${encodeURIComponent(communityId)}/metrics/public/usage?period=${activePeriod}`),
                fetch(`${API_BASE}/sync/status`).catch(err => { console.warn('Sync status fetch failed (non-critical):', err.message); return null; }),
                fetch(`${API_BASE}/sync/health`).catch(err => { console.warn('Health check fetch failed (non-critical):', err.message); return null; }),
            ]);

            const failedStatus = !summaryResp.ok ? summaryResp.status : (!usageResp.ok ? usageResp.status : null);
            if (failedStatus) throw { status: failedStatus };

            const summary = await summaryResp.json();
            const usage = await usageResp.json();
            const sync = syncResp && syncResp.ok ? await syncResp.json() : null;
            const health = healthResp && healthResp.ok ? await healthResp.json() : null;

            renderCommunityView(summary, usage, sync, health, communityId);
            document.getElementById('adminCard').style.display = '';

            if (adminKey) loadAdminData(communityId);
        } catch (err) {
            console.error('Failed to load community view:', communityId, err);
            app.className = '';
            const msg = userFriendlyError(err.status || null, `Community "${safeName}"`);
            app.innerHTML = `<div class="error-msg">${escapeHtml(msg)}</div>`;
        }
    }

    function renderCommunityView(summary, usage, sync, health, communityId) {
        const app = document.getElementById('app');
        const safeName = escapeHtml(communityId);
        const successRate = summary.total_requests > 0
            ? ((1 - summary.error_rate) * 100).toFixed(1) : '0.0';

        const VALID_STATUSES = ['healthy', 'degraded', 'error'];
        let healthStatus = 'unknown';
        let healthLabel = 'Unknown';
        if (health && health.status && VALID_STATUSES.includes(health.status)) {
            healthStatus = health.status;
            healthLabel = healthStatus.charAt(0).toUpperCase() + healthStatus.slice(1);
        }

        app.className = '';
        app.innerHTML = `
            <div class="card">
                <div class="community-header">
                    <h2 style="border:none;padding:0;margin:0;">${safeName.toUpperCase()} Community</h2>
                    <span class="status-badge status-${healthStatus}">${healthLabel}</span>
                </div>
                <div class="overview-grid">
                    <div class="metric">
                        <div class="metric-value">${summary.total_requests.toLocaleString()}</div>
                        <div class="metric-label">Requests</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${successRate}%</div>
                        <div class="metric-label">Success Rate</div>
                    </div>
                </div>
                ${renderSyncInfo(sync)}
            </div>
            <div class="card">
                <h2>Activity</h2>
                <div class="period-toggle">
                    <button class="period-btn ${activePeriod === 'daily' ? 'active' : ''}" onclick="changePeriod('daily','${encodeURIComponent(communityId)}')">Daily</button>
                    <button class="period-btn ${activePeriod === 'weekly' ? 'active' : ''}" onclick="changePeriod('weekly','${encodeURIComponent(communityId)}')">Weekly</button>
                    <button class="period-btn ${activePeriod === 'monthly' ? 'active' : ''}" onclick="changePeriod('monthly','${encodeURIComponent(communityId)}')">Monthly</button>
                </div>
                <div class="chart-row">
                    <div>
                        <h3 style="color:#374151;margin-bottom:0.5rem;">Requests Over Time</h3>
                        <div class="chart-container"><canvas id="usageChart"></canvas></div>
                    </div>
                    <div>
                        <h3 style="color:#374151;margin-bottom:0.5rem;">Top Tools</h3>
                        <div class="chart-container"><canvas id="toolsChart"></canvas></div>
                    </div>
                </div>
                <div class="admin-section" id="adminSection">
                    <h3>Admin: Token & Cost Details</h3>
                    <div class="chart-row">
                        <div>
                            <h3 style="color:#374151;margin-bottom:0.5rem;font-size:1rem;">Token Usage by Model</h3>
                            <div class="chart-container"><canvas id="adminTokenChart"></canvas></div>
                        </div>
                        <div>
                            <h3 style="color:#374151;margin-bottom:0.5rem;font-size:1rem;">Key Source Breakdown</h3>
                            <div class="chart-container"><canvas id="adminCostChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        renderUsageChart(usage);
        renderToolsChart(summary.top_tools);
    }

    function renderSyncInfo(sync) {
        if (!sync) return '';
        let lastGithub = 'N/A';
        let lastPapers = 'N/A';

        if (sync.github && sync.github.repos) {
            const times = Object.values(sync.github.repos).map(r => r.last_sync).filter(Boolean);
            if (times.length > 0) lastGithub = formatRelativeTime(times.sort().reverse()[0]);
        }
        if (sync.papers && sync.papers.sources) {
            const times = Object.values(sync.papers.sources).map(s => s.last_sync).filter(Boolean);
            if (times.length > 0) lastPapers = formatRelativeTime(times.sort().reverse()[0]);
        }

        return `
            <div class="sync-info">
                <div class="sync-item">
                    <div class="sync-item-label">GitHub Sync</div>
                    <div class="sync-item-value">${lastGithub}</div>
                </div>
                <div class="sync-item">
                    <div class="sync-item-label">Papers Sync</div>
                    <div class="sync-item-value">${lastPapers}</div>
                </div>
            </div>`;
    }

    function formatRelativeTime(isoStr) {
        try {
            const diffMs = new Date() - new Date(isoStr);
            const diffHrs = Math.floor(diffMs / 3600000);
            if (diffHrs < 1) return 'Less than 1 hour ago';
            if (diffHrs < 24) return `${diffHrs} hour${diffHrs === 1 ? '' : 's'} ago`;
            const diffDays = Math.floor(diffHrs / 24);
            return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
        } catch (err) { console.warn('Failed to parse timestamp:', isoStr, err); return isoStr || 'N/A'; }
    }

    // -----------------------------------------------------------------------
    // Charts
    // -----------------------------------------------------------------------
    function renderUsageChart(usage) {
        if (usageChartInstance) usageChartInstance.destroy();
        const canvas = document.getElementById('usageChart');
        if (!canvas || !usage.buckets || usage.buckets.length === 0) return;

        usageChartInstance = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: usage.buckets.map(b => b.bucket),
                datasets: [
                    {
                        label: 'Requests',
                        data: usage.buckets.map(b => b.requests),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: '#667eea', borderWidth: 1,
                    },
                    {
                        label: 'Errors',
                        data: usage.buckets.map(b => b.errors),
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: '#ef4444', borderWidth: 1,
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }

    function renderToolsChart(topTools) {
        if (toolsChartInstance) toolsChartInstance.destroy();
        const canvas = document.getElementById('toolsChart');
        if (!canvas || !topTools || topTools.length === 0) {
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#6b7280';
                ctx.textAlign = 'center';
                ctx.fillText('No tool usage data yet', canvas.width / 2, canvas.height / 2);
            }
            return;
        }
        toolsChartInstance = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: topTools.map(t => t.tool),
                datasets: [{
                    label: 'Calls',
                    data: topTools.map(t => t.count),
                    backgroundColor: COLORS.slice(0, topTools.length),
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }

    function changePeriod(period, communityId) {
        activePeriod = period;
        loadCommunityView(decodeURIComponent(communityId));
    }

    // -----------------------------------------------------------------------
    // Admin
    // -----------------------------------------------------------------------
    async function unlockAdmin() {
        const input = document.getElementById('adminKeyInput');
        const status = document.getElementById('adminStatus');
        const key = input.value.trim();
        if (!key) return;

        status.textContent = 'Verifying...';
        status.className = 'admin-status';

        try {
            const resp = await fetch(`${API_BASE}/metrics/overview`, {
                headers: { 'X-API-Key': key }
            });
            if (resp.ok) {
                adminKey = key;
                input.value = '';
                status.textContent = 'Unlocked';
                status.className = 'admin-status success';
                const route = getRoute();
                if (route.community) loadAdminData(route.community);
            } else if (resp.status === 403 || resp.status === 401) {
                status.textContent = 'Invalid key';
                status.className = 'admin-status error';
            } else {
                status.textContent = `Error (${resp.status})`;
                status.className = 'admin-status error';
            }
        } catch (err) {
            console.error('Admin unlock failed:', err);
            status.textContent = 'Connection error';
            status.className = 'admin-status error';
        }
    }

    async function loadAdminData(communityId) {
        if (!adminKey) return;
        const section = document.getElementById('adminSection');
        if (!section) return;

        try {
            const resp = await fetch(
                `${API_BASE}/metrics/tokens?community_id=${encodeURIComponent(communityId)}`,
                { headers: { 'X-API-Key': adminKey } }
            );
            if (!resp.ok) {
                if (resp.status === 401 || resp.status === 403) {
                    adminKey = null;
                    section.classList.remove('visible');
                    document.getElementById('adminStatus').textContent = 'Key expired or invalid';
                    document.getElementById('adminStatus').className = 'admin-status error';
                } else {
                    console.error('Admin data fetch failed with status', resp.status);
                    section.classList.add('visible');
                    section.innerHTML = `<p class="error-msg">Failed to load admin data (HTTP ${resp.status})</p>`;
                }
                return;
            }
            section.classList.add('visible');
            renderAdminCharts(await resp.json());
        } catch (err) {
            console.error('Failed to load admin data:', err);
            section.classList.add('visible');
            section.innerHTML = '<p class="error-msg">Failed to load admin data. Check console for details.</p>';
        }
    }

    function renderAdminCharts(data) {
        if (adminTokenChartInstance) adminTokenChartInstance.destroy();
        const tokenCanvas = document.getElementById('adminTokenChart');
        if (tokenCanvas && data.by_model && data.by_model.length > 0) {
            adminTokenChartInstance = new Chart(tokenCanvas, {
                type: 'doughnut',
                data: {
                    labels: data.by_model.map(m => m.model || 'Unknown'),
                    datasets: [{ data: data.by_model.map(m => m.total_tokens), backgroundColor: COLORS.slice(0, data.by_model.length) }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: { label: ctx => {
                            const m = data.by_model[ctx.dataIndex];
                            return `${m.model}: ${m.total_tokens.toLocaleString()} tokens ($${m.estimated_cost.toFixed(4)})`;
                        }}}
                    }
                }
            });
        }

        if (adminCostChartInstance) adminCostChartInstance.destroy();
        const costCanvas = document.getElementById('adminCostChart');
        if (costCanvas && data.by_key_source && data.by_key_source.length > 0) {
            adminCostChartInstance = new Chart(costCanvas, {
                type: 'doughnut',
                data: {
                    labels: data.by_key_source.map(k => k.key_source || 'Unknown'),
                    datasets: [{ data: data.by_key_source.map(k => k.requests), backgroundColor: ['#667eea', '#10b981', '#f59e0b', '#ef4444'] }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: { label: ctx => {
                            const s = data.by_key_source[ctx.dataIndex];
                            return `${s.key_source}: ${s.requests} requests ($${s.estimated_cost.toFixed(4)})`;
                        }}}
                    }
                }
            });
        }
    }
    </script>
</body>
</html>
