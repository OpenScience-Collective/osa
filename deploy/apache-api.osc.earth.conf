# Apache configuration for api.osc.earth
# Location: /etc/apache2/sites-available/api.osc.earth.conf
#
# This configuration proxies requests to the OSA Docker containers
# running on localhost ports 38528 (prod) and 38529 (dev).

<VirtualHost *:80>
    ServerName api.osc.earth

    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName api.osc.earth

    # SSL Configuration (adjust paths as needed)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/api.osc.earth/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/api.osc.earth/privkey.pem

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/api.osc.earth-error.log
    CustomLog ${APACHE_LOG_DIR}/api.osc.earth-access.log combined

    # ==========================================================================
    # PRODUCTION: OSA API Backend (port 38528)
    # ==========================================================================
    # Main API endpoints
    ProxyPass / http://localhost:38528/
    ProxyPassReverse / http://localhost:38528/

    # Proxy settings
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    # WebSocket support (if needed for streaming)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) ws://localhost:38528/$1 [P,L]
</VirtualHost>

# =============================================================================
# DEVELOPMENT: api-dev.osc.earth (port 38529)
# =============================================================================
# Uncomment and configure if you want a separate dev subdomain
#
# <VirtualHost *:443>
#     ServerName api-dev.osc.earth
#
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/api-dev.osc.earth/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/api-dev.osc.earth/privkey.pem
#
#     ProxyPass / http://localhost:38529/
#     ProxyPassReverse / http://localhost:38529/
#     ProxyPreserveHost On
# </VirtualHost>

# =============================================================================
# Alternative: Path-based routing (like HEDit)
# =============================================================================
# If you prefer path-based routing instead of subdomain-based:
#
# ProxyPass /osa/ http://localhost:38528/
# ProxyPassReverse /osa/ http://localhost:38528/
#
# ProxyPass /osa-dev/ http://localhost:38529/
# ProxyPassReverse /osa-dev/ http://localhost:38529/

# =============================================================================
# Setup Instructions
# =============================================================================
#
# 1. Copy this file to the server:
#    scp deploy/apache-api.osc.earth.conf user@hedtools.ucsd.edu:/tmp/
#
# 2. Move to Apache sites directory:
#    sudo mv /tmp/apache-api.osc.earth.conf /etc/apache2/sites-available/
#
# 3. Enable required modules:
#    sudo a2enmod proxy proxy_http ssl rewrite headers
#
# 4. Obtain SSL certificate (if not already done):
#    sudo certbot certonly --apache -d api.osc.earth
#
# 5. Enable the site:
#    sudo a2ensite api.osc.earth.conf
#
# 6. Test Apache config:
#    sudo apache2ctl configtest
#
# 7. Reload Apache:
#    sudo systemctl reload apache2
#
# 8. Verify:
#    curl https://api.osc.earth/health
