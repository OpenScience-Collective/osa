# OSA Cloudflare Worker Configuration
# https://developers.cloudflare.com/workers/wrangler/configuration/

name = "osa-worker"
main = "index.js"
compatibility_date = "2024-01-01"
account_id = "10f166f3ec8395ff4a219f581c5f359d"

# Production environment (default)
[vars]
BACKEND_URL = "https://api.osc.earth/osa"
ENVIRONMENT = "production"

# Hybrid rate limiting approach:
# - Per-minute (bot protection): Built-in API (fast, in-memory)
# - Per-hour (human abuse): KV (global consistency)

# Per-minute rate limiter (built-in API, free, <1ms latency)
[[ratelimits]]
name = "RATE_LIMITER_MINUTE"
namespace_id = "1001"
simple = { limit = 10, period = 60 }

# Per-hour rate limiter (KV, global, 1 write per request)
[[kv_namespaces]]
binding = "RATE_LIMITER_KV"
id = "8f8506b1a7fb400680a00014312c124d"

# Development environment
[env.dev]
name = "osa-worker-dev"
vars = { BACKEND_URL = "https://api.osc.earth/osa-dev", ENVIRONMENT = "development" }

# Per-minute rate limiter (dev has higher limit: 60/min)
[[env.dev.ratelimits]]
name = "RATE_LIMITER_MINUTE"
namespace_id = "1002"
simple = { limit = 60, period = 60 }

# Per-hour rate limiter (KV)
[[env.dev.kv_namespaces]]
binding = "RATE_LIMITER_KV"
id = "6d46ef72877b4129b38ef2ca1e1cd5ea"

# =============================================================================
# Setup Instructions
# =============================================================================
#
# 1. Install wrangler:
#    npm install -g wrangler
#
# 2. Login to Cloudflare:
#    wrangler login
#
# 3. KV namespaces already exist (IDs in this file)
#
# 4. Set secrets:
#    wrangler secret put BACKEND_API_KEY
#    wrangler secret put TURNSTILE_SECRET_KEY
#    wrangler secret put BACKEND_API_KEY --env dev
#    wrangler secret put TURNSTILE_SECRET_KEY --env dev
#
# 5. Deploy:
#    wrangler deploy           # Production
#    wrangler deploy --env dev # Development
#
# 6. Verify:
#    curl https://osa-worker.<your-subdomain>.workers.dev/health
#
# =============================================================================
# Turnstile Setup
# =============================================================================
#
# 1. Go to Cloudflare Dashboard > Turnstile
# 2. Create a new widget with "Visible" mode
# 3. Add hostnames where the widget will be embedded:
#    - hedtags.org
#    - hed-examples.org
#    - localhost (for development)
# 4. Copy the Site Key (for frontend) and Secret Key (for this worker)
# 5. Set the secret key:
#    wrangler secret put TURNSTILE_SECRET_KEY
