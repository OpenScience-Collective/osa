<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OSA Chat Widget Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
      background: #f9fafb;
      min-height: 100vh;
    }
    h1 {
      color: #1f2937;
      margin-bottom: 16px;
    }
    p {
      color: #6b7280;
      line-height: 1.6;
    }
    .info-box {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin: 24px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .info-box h2 {
      margin-top: 0;
      color: #1f2937;
    }
    code {
      background: #e5e7eb;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
    }
    pre code {
      background: transparent;
      color: inherit;
    }
    ul {
      color: #4b5563;
    }
    li {
      margin: 8px 0;
    }
    .community-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }
    .community-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-decoration: none;
      color: inherit;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .community-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }
    .community-card h3 {
      margin: 0 0 8px 0;
      color: #1f2937;
    }
    .community-card p {
      margin: 0;
      font-size: 14px;
    }
    .community-card .status {
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 12px;
      margin-top: 12px;
    }
    .status-active {
      background: #d1fae5;
      color: #065f46;
    }
    .status-soon {
      background: #fef3c7;
      color: #92400e;
    }
    .feature-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }
    .feature-item {
      background: #f3f4f6;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      color: #374151;
    }
    .feature-item strong {
      display: block;
      color: #1f2937;
      margin-bottom: 4px;
    }
    .badge {
      display: inline-block;
      font-size: 12px;
      background: #dbeafe;
      color: #1e40af;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px;
      vertical-align: middle;
    }
    .links {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .links a {
      color: #2563eb;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .links a:hover {
      text-decoration: underline;
    }
    .links a::before {
      content: 'â†’';
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="page-content"></div>

  <!-- Load the OSA Chat Widget -->
  <script src="osa-chat-widget.js"></script>

  <script>
    // Community configurations fetched from the API
    let COMMUNITIES = {};

    // Determine API endpoint (same logic as the widget)
    const hostname = window.location.hostname;
    const isDemoPage = hostname === 'osa-demo.pages.dev';
    const API_BASE = isDemoPage
      ? 'https://osa-worker.shirazi-10f.workers.dev'
      : 'https://osa-worker-dev.shirazi-10f.workers.dev';

    // Fetch community configs from the backend
    async function loadCommunities() {
      try {
        const response = await fetch(`${API_BASE}/communities`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        if (!Array.isArray(data)) {
          throw new Error('Invalid response format');
        }

        for (const community of data) {
          const w = community.widget || {};
          const shortName = community.name.split('(')[0].trim() || community.name;
          COMMUNITIES[community.id] = {
            name: shortName,
            fullName: community.name,
            description: community.description,
            status: community.status === 'available' ? 'active' : 'soon',
            widget: {
              communityId: community.id,
              title: w.title,
              initialMessage: w.initial_message || `Hi! I'm the ${shortName} Assistant. How can I help you?`,
              placeholder: w.placeholder,
              suggestedQuestions: w.suggested_questions || []
            }
          };
        }
      } catch (error) {
        console.error('[OSA] Failed to load communities from API:', error);
        const container = document.getElementById('page-content');
        container.textContent = '';
        const h1 = document.createElement('h1');
        h1.textContent = 'Open Science Assistant';
        const box = document.createElement('div');
        box.className = 'info-box';
        const h2 = document.createElement('h2');
        h2.textContent = 'Could not load communities';
        const p1 = document.createElement('p');
        p1.textContent = 'Failed to connect to the backend API. Please try refreshing the page.';
        const p2 = document.createElement('p');
        p2.style.cssText = 'color: #6b7280; font-size: 0.9em;';
        p2.textContent = `Error: ${error.message}`;
        box.append(h2, p1, p2);
        container.append(h1, box);
        return;
      }

      // Route after loading
      const communityId = getCommunityFromPath();
      if (communityId) {
        renderCommunity(communityId);
      } else {
        renderLanding();
      }
    }

    // Determine community from URL path (first segment only)
    function getCommunityFromPath() {
      const path = window.location.pathname.replace(/^\/+|\/+$/g, '').toLowerCase();
      if (!path) return null; // Landing page
      // Use only the first path segment (ignore sub-paths like /hed/docs)
      const firstSegment = path.split('/')[0];
      if (Object.hasOwn(COMMUNITIES, firstSegment)) {
        return firstSegment;
      }
      // Unknown path - redirect to landing
      if (path) {
        window.history.replaceState(null, '', '/');
      }
      return null;
    }

    // Render landing page (no specific community)
    function renderLanding() {
      document.title = 'Open Science Assistant - Demo';
      const html = `
        <h1>Open Science Assistant</h1>
        <p>AI-powered assistants for research communities. Each community gets a specialized assistant with domain expertise, documentation, and tools.</p>

        <div class="info-box">
          <h2>Available Assistants</h2>
          <p>Click a community to try its assistant:</p>
        </div>

        <div class="community-cards">
          ${Object.entries(COMMUNITIES).map(([id, c]) => `
            <a href="/${id}" class="community-card">
              <h3>${c.name}</h3>
              <p>${c.description}</p>
              <span class="status ${c.status === 'active' ? 'status-active' : 'status-soon'}">
                ${c.status === 'active' ? 'Live' : 'Coming soon'}
              </span>
            </a>
          `).join('')}
        </div>

        <div class="info-box">
          <h2>Integration</h2>
          <p>Add an assistant to your website:</p>
          <pre><code>&lt;script src="https://osa-demo.pages.dev/osa-chat-widget.js"&gt;&lt;/script&gt;
&lt;script&gt;
  OSAChatWidget.setConfig({
    communityId: '${Object.keys(COMMUNITIES)[0] || 'hed'}'  // ${Object.keys(COMMUNITIES).length > 1 ? `or '${Object.keys(COMMUNITIES).slice(1).join("', '")}'` : ''}
  });
&lt;/script&gt;</code></pre>
          <p>The widget auto-configures the API endpoint based on the <code>communityId</code>.</p>
        </div>

        <div class="info-box">
          <h2>Configuration Options</h2>
          <ul>
            <li><code>communityId</code> - Which assistant to use (${Object.keys(COMMUNITIES).map(id => `'${id}'`).join(', ')})</li>
            <li><code>title</code> - Widget header title</li>
            <li><code>placeholder</code> - Input placeholder text</li>
            <li><code>initialMessage</code> - First greeting message from the assistant</li>
            <li><code>suggestedQuestions</code> - Array of clickable suggestion buttons</li>
            <li><code>widgetInstructions</code> - Per-page context instructions for the assistant</li>
            <li><code>apiEndpoint</code> - Backend API URL (auto-detected by default)</li>
            <li><code>storageKey</code> - localStorage key (auto-derived from communityId)</li>
            <li><code>turnstileSiteKey</code> - Cloudflare Turnstile site key (optional)</li>
          </ul>
        </div>

        <div class="info-box">
          <h2>Features</h2>
          <div class="feature-list">
            <div class="feature-item">
              <strong>Health Status</strong>
              Shows real-time backend connectivity
            </div>
            <div class="feature-item">
              <strong>Markdown Support</strong>
              Tables, code blocks, lists, links
            </div>
            <div class="feature-item">
              <strong>Resizable</strong>
              Drag top-left corner to resize
            </div>
            <div class="feature-item">
              <strong>Chat History</strong>
              Persists across page reloads
            </div>
            <div class="feature-item">
              <strong>Page Context</strong>
              Shares URL for relevant answers
            </div>
            <div class="feature-item">
              <strong>Bot Protection</strong>
              Optional Turnstile integration
            </div>
          </div>
        </div>

        <div class="info-box">
          <h2>Learn More</h2>
          <div class="links">
            <a href="https://docs.osc.earth/osa/" target="_blank" rel="noopener">Documentation</a>
            <a href="https://github.com/OpenScience-Collective/osa" target="_blank" rel="noopener">GitHub Repository</a>
            <a href="https://osc.earth" target="_blank" rel="noopener">Open Science Collective</a>
          </div>
        </div>
      `;
      document.getElementById('page-content').innerHTML = html;
    }

    // Render community-specific page
    function renderCommunity(communityId) {
      const community = COMMUNITIES[communityId];
      document.title = `${community.name} Assistant - OSA Demo`;

      const html = `
        <h1>${community.name} Assistant <span class="badge">${community.fullName}</span></h1>
        <p>${community.description}. Click the chat button in the bottom-right corner to start a conversation.</p>

        <div class="info-box">
          <h2>Try it out</h2>
          <p>Ask questions about:</p>
          <ul>
            ${community.widget.suggestedQuestions.map(q => `<li>${q}</li>`).join('')}
          </ul>
          ${community.status === 'soon' ? '<p><em>This assistant is in development. Some features may not work yet.</em></p>' : ''}
        </div>

        <div class="info-box">
          <h2>Add to Your Site</h2>
          <pre><code>&lt;script src="https://osa-demo.pages.dev/osa-chat-widget.js"&gt;&lt;/script&gt;
&lt;script&gt;
  OSAChatWidget.setConfig({
    communityId: '${communityId}',
    // Optional: provide page-specific context
    // widgetInstructions: 'Focus on topics relevant to this page.'
  });
&lt;/script&gt;</code></pre>
        </div>

        <div class="info-box">
          <h2>API Endpoints</h2>
          <ul>
            <li><code>POST /${communityId}/ask</code> - Single question</li>
            <li><code>POST /${communityId}/chat</code> - Multi-turn conversation</li>
            <li><code>GET /health</code> - Backend status check</li>
          </ul>
        </div>

        <div class="info-box">
          <h2>Other Assistants</h2>
          <div class="community-cards">
            ${Object.entries(COMMUNITIES).filter(([id]) => id !== communityId).map(([id, c]) => `
              <a href="/${id}" class="community-card">
                <h3>${c.name}</h3>
                <p>${c.description}</p>
                <span class="status ${c.status === 'active' ? 'status-active' : 'status-soon'}">
                  ${c.status === 'active' ? 'Live' : 'Coming soon'}
                </span>
              </a>
            `).join('')}
          </div>
        </div>

        <div class="info-box">
          <h2>Learn More</h2>
          <div class="links">
            <a href="https://docs.osc.earth/osa/" target="_blank" rel="noopener">Documentation</a>
            <a href="https://github.com/OpenScience-Collective/osa" target="_blank" rel="noopener">GitHub Repository</a>
            <a href="https://osc.earth" target="_blank" rel="noopener">Open Science Collective</a>
          </div>
        </div>
      `;
      document.getElementById('page-content').innerHTML = html;

      // Configure widget for this community
      OSAChatWidget.setConfig(community.widget);
    }

    // Load communities from API and then route
    loadCommunities();
  </script>
</body>
</html>
