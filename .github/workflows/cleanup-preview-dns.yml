name: Cleanup preview DNS records

on:
  # Run when branches are deleted
  delete:
  # Run when PRs are closed (merged or abandoned)
  pull_request:
    types: [closed]
  # Weekly cleanup for any orphaned records
  schedule:
    - cron: '0 3 * * 0'  # Sunday 3am UTC
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # Only run for branch deletions (not tag deletions)
    if: github.event_name != 'delete' || github.event.ref_type == 'branch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Delete preview domain for closed PR
        if: github.event_name == 'pull_request'
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          if [ -z "$CF_ZONE_ID" ]; then
            echo "::warning::CLOUDFLARE_ZONE_ID not set, skipping"
            exit 0
          fi

          # Sanitize branch name same way as deploy workflow
          BRANCH=$(echo "${{ github.head_ref }}" | tr '/' '-' | tr '[:upper:]' '[:lower:]' | cut -c1-28)
          FQDN="${BRANCH}-demo.osc.earth"
          PROJECT="osa-demo"

          # Skip protected branches
          if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "develop" ]; then
            echo "Skipping protected branch: ${BRANCH}"
            exit 0
          fi

          # Remove Pages custom domain first
          echo "Removing Pages custom domain: ${FQDN}"
          curl -sf -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${PROJECT}/domains/${FQDN}" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" || echo "Pages domain not found or already removed"

          # Then remove DNS record
          echo "Looking for DNS record: ${FQDN}"
          RECORDS=$(curl -sf -X GET \
            "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?name=${FQDN}&type=CNAME" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json")

          RECORD_ID=$(echo "$RECORDS" | jq -r '.result[0].id // empty')

          if [ -n "$RECORD_ID" ]; then
            echo "Deleting DNS record: ${FQDN} (${RECORD_ID})"
            curl -sf -X DELETE \
              "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records/${RECORD_ID}" \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json"
            echo "Deleted."
          else
            echo "No DNS record found for ${FQDN}"
          fi

      - name: Delete preview domain for deleted branch
        if: github.event_name == 'delete'
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          if [ -z "$CF_ZONE_ID" ]; then
            echo "::warning::CLOUDFLARE_ZONE_ID not set, skipping"
            exit 0
          fi

          BRANCH=$(echo "${{ github.event.ref }}" | tr '/' '-' | tr '[:upper:]' '[:lower:]' | cut -c1-28)
          FQDN="${BRANCH}-demo.osc.earth"
          PROJECT="osa-demo"

          if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "develop" ]; then
            echo "Skipping protected branch: ${BRANCH}"
            exit 0
          fi

          # Remove Pages custom domain
          echo "Removing Pages custom domain: ${FQDN}"
          curl -sf -X DELETE \
            "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${PROJECT}/domains/${FQDN}" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" || echo "Pages domain not found or already removed"

          # Remove DNS record
          echo "Looking for DNS record: ${FQDN}"
          RECORDS=$(curl -sf -X GET \
            "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?name=${FQDN}&type=CNAME" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json")

          RECORD_ID=$(echo "$RECORDS" | jq -r '.result[0].id // empty')

          if [ -n "$RECORD_ID" ]; then
            echo "Deleting DNS record: ${FQDN} (${RECORD_ID})"
            curl -sf -X DELETE \
              "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records/${RECORD_ID}" \
              -H "Authorization: Bearer ${CF_API_TOKEN}" \
              -H "Content-Type: application/json"
            echo "Deleted."
          else
            echo "No DNS record found for ${FQDN}"
          fi

      - name: Periodic cleanup of orphaned records
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -z "$CF_ZONE_ID" ]; then
            echo "::warning::CLOUDFLARE_ZONE_ID not set, skipping"
            exit 0
          fi

          PROJECT="osa-demo"

          echo "Fetching all *-demo.osc.earth CNAME records..."
          RECORDS=$(curl -sf -X GET \
            "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records?type=CNAME&per_page=100" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json")

          # Filter to *-demo.osc.earth records (excluding demo.osc.earth itself)
          echo "$RECORDS" | jq -r '.result[] | select(.name | endswith("-demo.osc.earth")) | "\(.id) \(.name)"' | while read -r RECORD_ID FQDN; do
            # Extract branch name: remove -demo.osc.earth suffix
            BRANCH=$(echo "$FQDN" | sed 's/-demo\.osc\.earth$//')

            # Skip protected branches
            if [ "$BRANCH" = "develop" ]; then
              echo "Keeping: ${FQDN} (protected branch)"
              continue
            fi

            # Check if branch exists in the repo
            if gh api "repos/${{ github.repository }}/branches/${BRANCH}" --silent 2>/dev/null; then
              echo "Keeping: ${FQDN} (branch exists)"
            else
              # Also check with original name (/ replaced with -)
              # Try to find any branch that sanitizes to this name
              FOUND=false
              while IFS= read -r REMOTE_BRANCH; do
                SANITIZED=$(echo "$REMOTE_BRANCH" | tr '/' '-' | tr '[:upper:]' '[:lower:]' | cut -c1-28)
                if [ "$SANITIZED" = "$BRANCH" ]; then
                  FOUND=true
                  break
                fi
              done < <(gh api "repos/${{ github.repository }}/branches" --paginate -q '.[].name')

              if [ "$FOUND" = "true" ]; then
                echo "Keeping: ${FQDN} (branch exists)"
              else
                echo "Deleting orphaned: ${FQDN} (no matching branch)"
                # Remove Pages custom domain
                curl -sf -X DELETE \
                  "https://api.cloudflare.com/client/v4/accounts/${CF_ACCOUNT_ID}/pages/projects/${PROJECT}/domains/${FQDN}" \
                  -H "Authorization: Bearer ${CF_API_TOKEN}" \
                  -H "Content-Type: application/json" || true
                # Remove DNS record
                curl -sf -X DELETE \
                  "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/dns_records/${RECORD_ID}" \
                  -H "Authorization: Bearer ${CF_API_TOKEN}" \
                  -H "Content-Type: application/json"
                echo "Deleted: ${FQDN}"
              fi
            fi
          done

          echo "Cleanup complete."
