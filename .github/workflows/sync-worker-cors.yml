name: Sync Worker CORS

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/assistants/*/config.yaml'
      - 'scripts/sync_worker_cors.py'
      - '.github/workflows/sync-worker-cors.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/assistants/*/config.yaml'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-cors:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.CI_ADMIN_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Run CORS sync script
        run: |
          python scripts/sync_worker_cors.py

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet workers/osa-worker/index.js; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No CORS changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "CORS changes detected"
          fi

      - name: Commit changes (main/develop only)
        if: steps.check_changes.outputs.changed == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add workers/osa-worker/index.js
          git commit -m "chore: sync worker CORS from community configs [skip ci]"
          git push

      - name: Deploy to Cloudflare Workers (production)
        if: steps.check_changes.outputs.changed == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          npm install -g wrangler
          cd workers/osa-worker
          wrangler deploy --env=""
          echo "✅ Deployed to production worker"

      - name: Deploy to Cloudflare Workers (dev)
        if: steps.check_changes.outputs.changed == 'true' && github.ref == 'refs/heads/develop' && github.event_name == 'push'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          npm install -g wrangler
          cd workers/osa-worker
          wrangler deploy --env=dev
          echo "✅ Deployed to dev worker"

      - name: Comment on PR
        if: steps.check_changes.outputs.changed == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Worker CORS Update Required**\n\nThis PR modifies community CORS origins. After merging, run:\n\n```bash\npython scripts/sync_worker_cors.py\ngit add workers/osa-worker/index.js\ngit commit -m "chore: sync worker CORS"\ncd workers/osa-worker && wrangler deploy\n```\n\nOr merge to main and the sync workflow will auto-commit the changes.'
            })
